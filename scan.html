<!DOCTYPE html>
<html lang="id">
<head>
<!-- Font Awesome CDN -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Absensi Digital Siswi Al-Hadiid</title>

<!-- Html5 QR Code Scanner -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
/* ==== Bottom Navigation ==== */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background-color: #46A6D9;
  display: flex;
  justify-content: space-around;
  align-items: center;
  padding: 8px 0;
  z-index: 1000;
}
.bottom-nav a {
  flex: 1;
  text-align: center;
  color: #fff;
  text-decoration: none;
  font-size: 12px;
  padding: 6px 0;
}
.bottom-nav a i {
  font-size: 20px;
  display: block;
  margin-bottom: 3px;
}
.bottom-nav a.active {
  background-color: #2f3e9e;
  border-radius: 6px;
}

body { 
  font-family:'Segoe UI',sans-serif;
  margin:0;
  padding:0;
  background:#f5f6fa; 
  padding-bottom: 70px;
  overflow-y: auto;
}
header { text-align:center;padding:30px 20px 10px; }
header h1 { color:#2f3e9e;margin-bottom:10px; }
header p { color:#555; }
.container { display:flex;flex-wrap:wrap;gap:20px;justify-content:center;padding:20px; }
.card { background:white;border-radius:10px;padding:20px;box-shadow:0 0 10px rgba(0,0,0,0.1);flex:1;min-width:320px;max-width:500px; }
.card h3 { margin-top:0;color:#2f3e9e; }
.label { font-weight:bold;margin-top:10px;color:#2f3e9e; }
.value { background:#f2f2f2;padding:8px 12px;border-radius:6px;margin-bottom:10px; }
.badge { display:inline-block;padding:5px 10px;border-radius:20px;font-size:13px;color:white; }
.btn { padding:10px 20px;border:none;color:white;font-weight:bold;border-radius:5px;cursor:pointer;margin-right:10px;font-size:14px; }
.btn-primary { background:#2f3e9e; }
.btn-danger { background:#e74c3c; }
.btn-export { background:#27ae60; }

/* ===== SCANNER CONTAINER ===== */
#reader {
  width: 100%;
  height: 300px;
  border-radius: 8px;
  position: relative;
  overflow: hidden;
  background: #000;
  margin-bottom: 15px;
}

/* Untuk desktop - tinggi lebih besar */
@media (min-width: 769px) {
  #reader {
    height: 400px;
  }
}

/* Loading camera styling */
#loadingCamera {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0,0,0,0.75);
  padding: 15px 25px;
  border-radius: 10px;
  color: white;
  z-index: 30;
  font-size: 16px;
  display: none;
  text-align: center;
}

/* Laser line animation */
.laser-line {
  position: absolute;
  top: 0;
  left: 10%;
  width: 80%;
  height: 3px;
  background: #ff0000;
  box-shadow: 0 0 10px #ff0000;
  animation: laserMove 2s linear infinite;
  z-index: 20;
  opacity: 0.8;
  border-radius: 50%;
}

@keyframes laserMove {
  0% { top: 10%; }
  50% { top: 50%; }
  100% { top: 90%; }
}

/* Scanner border untuk visual yang lebih baik */
#reader::before {
  content: '';
  position: absolute;
  top: 20px;
  left: 20px;
  right: 20px;
  bottom: 20px;
  border: 2px solid rgba(255,255,255,0.3);
  border-radius: 8px;
  z-index: 10;
  pointer-events: none;
}

/* Tombol Flash */
.flash-container {
  display: flex;
  align-items: center;
  gap: 10px;
}

#flashBtn {
  background: #2f3e9e; 
  color: white; 
  border: none; 
  padding: 8px 12px;
  border-radius: 6px; 
  cursor: pointer; 
  display: flex; 
  align-items: center;
  gap: 6px; 
  font-size: 14px;
}

#flashBtn:disabled {
  background: #95a5a6;
  cursor: not-allowed;
}

@media (max-width:768px) {
  .container { flex-direction:column;padding:10px; }
  .card { max-width:100%; }
  #reader { height:300px !important; }
}
</style>
</head>

<!-- ==== Bottom Navigation Bar ==== -->
<nav class="bottom-nav">
  <a href="izin.html"><i class="fa fa-check-square"></i>Izin</a>
  <a href="scan.html" class="active"><i class="fa fa-qrcode"></i>Scan</a>
  <a href="recap.html"><i class="fa fa-book"></i>Recap</a>
</nav>

<body>

<header>
<h1>Absensi Digital Siswi SMA Al Hadiid</h1>
<p>Scan kartu barcode peserta untuk mencatat kehadiran</p>
</header>

<div class="container">

<!-- ============================== -->
<!--   CARD SCAN + TOMBOL FLASH     -->
<!-- ============================== -->
<div class="card">

  <div class="flash-container">
    <h3 style="margin: 0; flex: 1;">Scan Barcode Anda Disini</h3>

    <!-- Tombol Flash - SEDERHANA dan PASTI MUNCUL -->
    <button id="flashBtn">
        <i class="fa-solid fa-bolt"></i> Flash
    </button>
  </div>

  <hr />

  <div id="reader">
      <div id="loadingCamera">ðŸ“· Mengaktifkan Kamera...</div>
      <div class="laser-line"></div>
  </div>

</div>


<!-- ============================== -->
<!--            CARD DATA           -->
<!-- ============================== -->

<div class="card">
<h3>Data Peserta</h3>
<hr />

<div class="label">Status:</div>
<div class="value"><span class="badge" id="status" style="background-color: orange;">Menunggu scan</span></div>

<div class="label">Nama:</div>
<div class="value" id="nama">-</div>

<div class="label">Kelas:</div>
<div class="value" id="kelas">-</div>

<div class="label">Nomor Absen:</div>
<div class="value" id="absen">-</div>

<div class="label">Keterangan:</div>
<div class="value" id="keterangan">-</div>

<div class="label">Waktu Absensi:</div>
<div class="value" id="waktu">-</div>

<div class="label">Jarak ke Sekolah:</div>
<div class="value" id="jarakSekolah">Menghitung...</div>

<div style="margin-top:20px;">
<button class="btn btn-primary" onclick="simpanPresensi()">Simpan Presensi</button>
<button class="btn btn-danger" onclick="resetData()">Reset</button>
</div>
</div>

</div> <!-- container END -->

<script>
/* ============ FIREBASE CONFIG ============= */
const firebaseConfig = {
  apiKey: "AIzaSyBr4DNrjgpg1z_VVuP_uBJEs4iy0zkLOig",
  authDomain: "absensi-digital-199d2.firebaseapp.com",
  databaseURL: "https://absensi-digital-199d2-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "absensi-digital-199d2",
  storageBucket: "absensi-digital-199d2.appspot.com",
  messagingSenderId: "387823714427",
  appId: "1:387823714427:web:6938dd60c1fcf1a87662de"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

/* ============ SCANNER ============= */
const scanner = new Html5Qrcode("reader");

/* Success beep */
const audioSuccess = new Audio(
  "https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"
);

/* Error beep */
const audioError = new Audio(
  "https://actions.google.com/sounds/v1/alarms/beep_short.ogg"
);

/* LOADING CAMERA */
document.getElementById("loadingCamera").style.display = "block";

/* GPS & Radius */
const schoolLat = -6.408638;
const schoolLng = 106.963852;
const radiusM = 1000;
const jamMulaiAbsensi = 6;
const jamAkhirAbsensi = 7;

let semuaPresensi = {};
let keteranganScan = null;
let scanDataGPS = null;
let currentVideoTrack = null;
let flashOn = false;
let cameraReady = false;

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

function startScanner() {
  scanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: { width: 250, height: 150 } },
    hasil => {
      scanner.pause();
      audioSuccess.play();
      navigator.vibrate?.(120);

      navigator.geolocation.getCurrentPosition(
        pos => prosesDataGPS(hasil, pos.coords.latitude, pos.coords.longitude),
        err => {
          audioError.play();
          alert("Tidak bisa mendapatkan lokasi GPS!");
          restartScanner();
        }
      );
    },
    err => {
      // Error handling untuk scan
      console.log("Scan error:", err);
    }
  )
  .then(() => {
    document.getElementById("loadingCamera").style.display = "none";
    
    // Setup flash capability setelah scanner ready
    setTimeout(() => {
      setupFlashCapability();
    }, 1500);
  })
  .catch(err => {
    document.getElementById("loadingCamera").style.display = "none";
    alert("Gagal mengakses kamera: " + err.message);
  });
}

function setupFlashCapability() {
  try {
    // Cari elemen video yang dibuat oleh scanner
    const videoElement = document.querySelector('#reader video');
    console.log("Video element:", videoElement);
    
    if (videoElement && videoElement.srcObject) {
      const stream = videoElement.srcObject;
      const tracks = stream.getVideoTracks();
      console.log("Video tracks:", tracks);
      
      if (tracks.length > 0) {
        currentVideoTrack = tracks[0];
        cameraReady = true;
        
        const capabilities = currentVideoTrack.getCapabilities();
        console.log("Camera capabilities:", capabilities);
        
        const flashBtn = document.getElementById('flashBtn');
        
        // Cek apakah device mendukung flash/torch
        if (capabilities.torch) {
          console.log("Flash DIDUKUNG - tombol aktif");
          flashBtn.disabled = false;
          flashBtn.innerHTML = '<i class="fa-solid fa-bolt"></i> Flash';
        } else {
          console.log("Flash TIDAK didukung device ini");
          flashBtn.disabled = true;
          flashBtn.innerHTML = '<i class="fa-solid fa-bolt-slash"></i> No Flash';
          flashBtn.style.background = '#95a5a6';
        }
      } else {
        console.log("Tidak ada video track ditemukan");
        // Coba lagi
        setTimeout(setupFlashCapability, 500);
      }
    } else {
      console.log("Video element tidak ditemukan, coba lagi...");
      setTimeout(setupFlashCapability, 500);
    }
  } catch (error) {
    console.error("Error setting up flash:", error);
  }
}

async function toggleFlash() {
  if (!cameraReady || !currentVideoTrack) {
    alert("Kamera belum siap! Tunggu beberapa detik.");
    return;
  }

  const flashBtn = document.getElementById('flashBtn');
  
  if (flashBtn.disabled) {
    alert("Flash tidak didukung di device ini.");
    return;
  }

  try {
    flashOn = !flashOn;
    
    await currentVideoTrack.applyConstraints({
      advanced: [{ torch: flashOn }]
    });

    // Update tombol flash
    flashBtn.style.background = flashOn ? "#e67e22" : "#2f3e9e";
    flashBtn.innerHTML = flashOn 
      ? '<i class="fa-solid fa-bolt"></i> Flash ON'
      : '<i class="fa-solid fa-bolt"></i> Flash';

    console.log("Flash status:", flashOn ? "ON" : "OFF");
    
  } catch (error) {
    console.error("Gagal mengontrol flash:", error);
    alert("Gagal mengontrol flash: " + error.message);
  }
}

function restartScanner() {
  setTimeout(() => {
    scanner.resume();
    document.getElementById("status").textContent = "Menunggu scan";
    document.getElementById("status").style.backgroundColor = "orange";
  }, 2000);
}

function prosesDataGPS(data, lat, lng) {
  const now = new Date();
  const jamSekarang = now.getHours();
  const menitSekarang = now.getMinutes();

  let nama = "-", kelas = "-", absen = "-";

  try {
    const obj = JSON.parse(data);
    nama = obj.nama || "-"; 
    kelas = obj.kelas || "-"; 
    absen = obj.absen || "-"; 
  } catch(e) {
    audioError.play();
    nama = data;
  }

  const jarak = getDistance(schoolLat, schoolLng, lat, lng);
  document.getElementById("jarakSekolah").textContent = `${Math.round(jarak)} meter`;

  if(jarak > radiusM) {
    document.getElementById("status").textContent = "Di luar area sekolah!";
    document.getElementById("status").style.backgroundColor = "#e74c3e";
    restartScanner();
    return;
  }

  document.getElementById("status").textContent = "Berhasil scan";
  document.getElementById("status").style.backgroundColor = "#27ae60";
  document.getElementById("nama").textContent = nama;
  document.getElementById("kelas").textContent = kelas;
  document.getElementById("absen").textContent = absen;

  let keterangan = "Hadir";
  let warna = "#27ae60";
  if(jamSekarang > jamAkhirAbsensi || (jamSekarang === jamAkhirAbsensi && menitSekarang > 0)) { 
    keterangan = "Telat"; 
    warna = "#e74c3c"; 
  }
  
  document.getElementById("keterangan").innerHTML = `<span class="badge" style="background-color:${warna};">${keterangan}</span>`;
  document.getElementById("waktu").textContent = now.toLocaleString();
  
  keteranganScan = keterangan;
  scanDataGPS = { lat, lng };
}

function resetData() {
  document.getElementById("status").textContent = "Menunggu scan";
  document.getElementById("status").style.backgroundColor = "orange";
  document.getElementById("nama").textContent = "-";
  document.getElementById("kelas").textContent = "-";
  document.getElementById("absen").textContent = "-";
  document.getElementById("keterangan").textContent = "-";
  document.getElementById("waktu").textContent = "-";
  document.getElementById("jarakSekolah").textContent = "Menghitung...";
  
  keteranganScan = null;
  scanDataGPS = null;
  
  // Restart scanner
  if (scanner && typeof scanner.resume === 'function') {
    scanner.resume();
  }
}

function simpanPresensi() {
  const nama = document.getElementById("nama").textContent;
  const kelas = document.getElementById("kelas").textContent;
  const absen = document.getElementById("absen").textContent;
  const keterangan = keteranganScan || "-";
  const gps = scanDataGPS || { lat: null, lng: null };

  if(nama === "-" || kelas === "-" || absen === "-") { 
    audioError.play();
    alert("Data peserta belum lengkap!"); 
    return; 
  }

  const now = new Date();
  const today = now.toISOString().split("T")[0];
  
  // Cek apakah sudah absen hari ini
  const sudahAbsen = Object.values(semuaPresensi).some(item => {
    if (!item) return false;
    return item.nama === nama && item.kelas === kelas && item.absen === absen && item.waktu && item.waktu.startsWith(today);
  });
  
  if(sudahAbsen) { 
    audioError.play();
    alert("Anda sudah absen hari ini!"); 
    return; 
  }

  const newKey = database.ref().child('presensi').push().key;
  database.ref('presensi/' + newKey).set({
    nama, kelas, absen, keterangan, 
    waktu: now.toISOString(), 
    lat: gps.lat, 
    lng: gps.lng
  }).then(() => { 
    audioSuccess.play();
    alert("Absensi Berhasil Tersimpan!"); 
    resetData(); 
  }).catch(err => {
    audioError.play();
    alert("Gagal simpan data: " + err.message); 
  });
}

// Perbaikan: Update semuaPresensi ketika data berubah
database.ref("presensi").on("value", snapshot => { 
  semuaPresensi = snapshot.val() || {};
});

document.getElementById("flashBtn").addEventListener("click", toggleFlash);

window.onload = () => { 
  startScanner(); 
};
</script>

</body>
</html>